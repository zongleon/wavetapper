import{D as A,O as f,S as g,P,a as v}from"./consts-Ce9091XP.js";import{A as G,a as k,c as _,b as V,e as y,d as x,s as O}from"./utils-CohX7Tt5.js";class w{constructor(){this.resolve=void 0,this.reject=void 0,this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}async value(){return await this.promise}}function W(s,e,t){const a=new XMLHttpRequest;a.open("GET",s,!0),a.responseType="arraybuffer",a.onload=()=>{a.status==200||a.status==0&&a.response?e(a.response):t()},a.onerror=t,a.send(null)}function m(s,e,t){W(s,a=>{e(new Uint8Array(a))},()=>{if(t)t();else throw new Error(`Loading data file ${s} failed.`)})}async function U(s){const e=s.map(t=>new Promise((a,n)=>{m(t.serverFilename,l=>{a({filename:t.virtualFilename,data:l})},()=>{console.error(`Error fetching file: ${t.serverFilename}`)})}));return await Promise.all(e)}async function M(s){return new Promise((e,t)=>{m(s+"webchuck.wasm",e,t)})}const Y=["ck","txt","csv","json","xml","html","js"];function H(s){const e=s.split(".").pop();return Y.includes(e)}const D=()=>new w;var r;(function(s){s.CREATE_FILE="createFile",s.CREATE_DIRECTORY="createDirectory",s.RUN_CODE="runChuckCode",s.RUN_CODE_WITH_REPLACEMENT_DAC="runChuckCodeWithReplacementDac",s.REPLACE_CODE="replaceChuckCode",s.REPLACE_CODE_WITH_REPLACEMENT_DAC="replaceChuckCodeWithReplacementDac",s.REMOVE_LAST_CODE="removeLastCode",s.RUN_FILE="runChuckFile",s.RUN_FILE_WITH_REPLACEMENT_DAC="runChuckFileWithReplacementDac",s.RUN_FILE_WITH_ARGS="runChuckFileWithArgs",s.REPLACE_FILE="replaceChuckFile",s.REPLACE_FILE_WITH_REPLACEMENT_DAC="replaceChuckFileWithReplacementDac",s.REPLACE_FILE_WITH_ARGS="replaceChuckFileWithArgs",s.REMOVE_SHRED="removeShred",s.IS_SHRED_ACTIVE="isShredActive",s.SIGNAL_EVENT="signalChuckEvent",s.BROADCAST_EVENT="broadcastChuckEvent",s.LISTEN_FOR_EVENT_ONCE="listenForChuckEventOnce",s.START_LISTENING_FOR_EVENT="startListeningForChuckEvent",s.STOP_LISTENING_FOR_EVENT="stopListeningForChuckEvent",s.SET_INT="setChuckInt",s.GET_INT="getChuckInt",s.SET_FLOAT="setChuckFloat",s.GET_FLOAT="getChuckFloat",s.SET_STRING="setChuckString",s.GET_STRING="getChuckString",s.SET_INT_ARRAY="setGlobalIntArray",s.GET_INT_ARRAY="getGlobalIntArray",s.SET_INT_ARRAY_VALUE="setGlobalIntArrayValue",s.GET_INT_ARRAY_VALUE="getGlobalIntArrayValue",s.SET_ASSOCIATIVE_INT_ARRAY_VALUE="setGlobalAssociativeIntArrayValue",s.GET_ASSOCIATIVE_INT_ARRAY_VALUE="getGlobalAssociativeIntArrayValue",s.SET_FLOAT_ARRAY="setGlobalFloatArray",s.GET_FLOAT_ARRAY="getGlobalFloatArray",s.SET_FLOAT_ARRAY_VALUE="setGlobalFloatArrayValue",s.GET_FLOAT_ARRAY_VALUE="getGlobalFloatArrayValue",s.SET_ASSOCIATIVE_FLOAT_ARRAY_VALUE="setGlobalAssociativeFloatArrayValue",s.GET_ASSOCIATIVE_FLOAT_ARRAY_VALUE="getGlobalAssociativeFloatArrayValue",s.SET_PARAM_INT="setParamInt",s.GET_PARAM_INT="getParamInt",s.SET_PARAM_FLOAT="setParamFloat",s.GET_PARAM_FLOAT="getParamFloat",s.SET_PARAM_STRING="setParamString",s.GET_PARAM_STRING="getParamString",s.GET_CHUCK_NOW="getChuckNow",s.CLEAR_INSTANCE="clearChuckInstance",s.CLEAR_GLOBALS="clearGlobals"})(r||(r={}));var c;(function(s){s.INIT_DONE="initCallback",s.PRINT="console print",s.EVENT="eventCallback",s.INT="intCallback",s.FLOAT="floatCallback",s.STRING="stringCallback",s.INT_ARRAY="intArrayCallback",s.FLOAT_ARRAY="floatArrayCallback",s.NEW_SHRED="newShredCallback",s.REPLACED_SHRED="replacedShredCallback",s.REMOVED_SHRED="removedShredCallback"})(c||(c={}));class d extends window.AudioWorkletNode{constructor(e,t,a,n=2){super(t,"chuck-node",{numberOfInputs:1,numberOfOutputs:1,outputChannelCount:[n],processorOptions:{chuckID:d.chuckID,srate:t.sampleRate,preloadedFiles:e,wasm:a}}),this.deferredPromises={},this.deferredPromiseCounter=0,this.eventCallbacks={},this.eventCallbackCounter=0,this.isReady=D(),this.chugins=[],this.port.onmessage=this.receiveMessage.bind(this),this.onprocessorerror=l=>console.error(l),d.chuckID++}static async init(e,t,a=2,n="https://chuck.stanford.edu/webchuck/src/"){let l=!1;t===void 0&&(t=new AudioContext,l=!0),e=e.concat(d.chuginsToLoad);const[E,T,F]=await Promise.all([M(n),t.audioWorklet.addModule(n+"webchuck.js"),U(e)]),u=new d(F,t,E,a);return u.chugins=d.chuginsToLoad.map(N=>N.virtualFilename.split("/").pop()),d.chuginsToLoad=[],l&&u.connect(t.destination),t.destination.channelCount=a,await u.isReady.promise,u}nextDeferID(){const e=this.deferredPromiseCounter++;return this.deferredPromises[e]=D(),e}createFile(e,t,a){this.sendMessage(r.CREATE_FILE,{directory:e,filename:t,data:a})}createDirectory(e,t){this.sendMessage(r.CREATE_DIRECTORY,{parent:e,name:t})}async loadFile(e){const t=e.split("/").pop(),a=H(t);return fetch(e).then(n=>a?n.text():n.arrayBuffer()).then(n=>{a?this.createFile("",t,n):this.createFile("",t,new Uint8Array(n))}).catch(n=>{throw new Error(n)})}static loadChugin(e){d.chuginsToLoad.push({serverFilename:e,virtualFilename:"/chugins/"+e.split("/").pop()})}loadedChugins(){return this.chugins}runCode(e){const t=this.nextDeferID();return this.sendMessage(r.RUN_CODE,{callback:t,code:e}),this.deferredPromises[t].value()}runCodeWithReplacementDac(e,t){const a=this.nextDeferID();return this.sendMessage(r.RUN_CODE_WITH_REPLACEMENT_DAC,{callback:a,code:e,dac_name:t}),this.deferredPromises[a].value()}replaceCode(e){const t=this.nextDeferID();return this.sendMessage(r.REPLACE_CODE,{callback:t,code:e}),this.deferredPromises[t].value()}replaceCodeWithReplacementDac(e,t){const a=this.nextDeferID();return this.sendMessage(r.REPLACE_CODE_WITH_REPLACEMENT_DAC,{callback:a,code:e,dac_name:t}),this.deferredPromises[a].value()}removeLastCode(){const e=this.nextDeferID();return this.sendMessage(r.REMOVE_LAST_CODE,{callback:e}),this.deferredPromises[e].value()}runFile(e){const t=this.nextDeferID();return this.sendMessage(r.RUN_FILE,{callback:t,filename:e}),this.deferredPromises[t].value()}runFileWithReplacementDac(e,t){const a=this.nextDeferID();return this.sendMessage(r.RUN_FILE_WITH_REPLACEMENT_DAC,{callback:a,dac_name:t,filename:e}),this.deferredPromises[a].value()}runFileWithArgs(e,t){const a=this.nextDeferID();return this.sendMessage(r.RUN_FILE_WITH_ARGS,{callback:a,colon_separated_args:t,filename:e}),this.deferredPromises[a].value()}runFileWithArgsWithReplacementDac(e,t,a){const n=this.nextDeferID();return this.sendMessage(r.RUN_FILE_WITH_ARGS,{callback:n,colon_separated_args:t,dac_name:a,filename:e}),this.deferredPromises[n].value()}replaceFile(e){const t=this.nextDeferID();return this.sendMessage(r.REPLACE_FILE,{callback:t,filename:e}),this.deferredPromises[t].value()}replaceFileWithReplacementDac(e,t){const a=this.nextDeferID();return this.sendMessage(r.REPLACE_FILE_WITH_REPLACEMENT_DAC,{callback:a,dac_name:t,filename:e}),this.deferredPromises[a].value()}replaceFileWithArgs(e,t){const a=this.nextDeferID();return this.sendMessage(r.REPLACE_FILE_WITH_ARGS,{callback:a,colon_separated_args:t,filename:e}),this.deferredPromises[a].value()}replaceFileWithArgsWithReplacementDac(e,t,a){const n=this.nextDeferID();return this.sendMessage(r.REPLACE_FILE_WITH_ARGS,{callback:n,colon_separated_args:t,dac_name:a,filename:e}),this.deferredPromises[n].value()}removeShred(e){const t=this.nextDeferID();return this.sendMessage(r.REMOVE_SHRED,{shred:e,callback:t}),this.deferredPromises[t].value()}isShredActive(e){const t=this.nextDeferID();return this.sendMessage(r.IS_SHRED_ACTIVE,{shred:e,callback:t}),this.deferredPromises[t].value()}signalEvent(e){this.sendMessage(r.SIGNAL_EVENT,{variable:e})}broadcastEvent(e){this.sendMessage(r.BROADCAST_EVENT,{variable:e})}listenForEventOnce(e,t){const a=this.eventCallbackCounter++;this.eventCallbacks[a]=t,this.sendMessage(r.LISTEN_FOR_EVENT_ONCE,{variable:e,callback:a})}startListeningForEvent(e,t){const a=this.eventCallbackCounter++;return this.eventCallbacks[a]=t,this.sendMessage(r.START_LISTENING_FOR_EVENT,{variable:e,callback:a}),a}stopListeningForEvent(e,t){this.sendMessage(r.STOP_LISTENING_FOR_EVENT,{variable:e,callback:t})}setInt(e,t){this.sendMessage(r.SET_INT,{variable:e,value:t})}getInt(e){const t=this.nextDeferID();return this.sendMessage(r.GET_INT,{variable:e,callback:t}),this.deferredPromises[t].value()}setFloat(e,t){this.sendMessage(r.SET_FLOAT,{variable:e,value:t})}getFloat(e){const t=this.nextDeferID();return this.sendMessage(r.GET_FLOAT,{variable:e,callback:t}),this.deferredPromises[t].value()}setString(e,t){this.sendMessage(r.SET_STRING,{variable:e,value:t})}getString(e){const t=this.nextDeferID();return this.sendMessage(r.GET_STRING,{variable:e,callback:t}),this.deferredPromises[t].value()}setIntArray(e,t){this.sendMessage(r.SET_INT_ARRAY,{variable:e,values:t})}getIntArray(e){const t=this.nextDeferID();return this.sendMessage(r.GET_INT_ARRAY,{variable:e,callback:t}),this.deferredPromises[t].value()}setIntArrayValue(e,t,a){this.sendMessage(r.SET_INT_ARRAY_VALUE,{variable:e,index:t,value:a})}getIntArrayValue(e,t){const a=this.nextDeferID();return this.sendMessage(r.GET_INT_ARRAY_VALUE,{variable:e,index:t,callback:a}),this.deferredPromises[a].value()}setAssociativeIntArrayValue(e,t,a){this.sendMessage(r.SET_ASSOCIATIVE_INT_ARRAY_VALUE,{variable:e,key:t,value:a})}getAssociativeIntArrayValue(e,t){const a=this.nextDeferID();return this.sendMessage(r.GET_ASSOCIATIVE_INT_ARRAY_VALUE,{variable:e,key:t,callback:a}),this.deferredPromises[a].value()}setFloatArray(e,t){this.sendMessage(r.SET_FLOAT_ARRAY,{variable:e,values:t})}getFloatArray(e){const t=this.nextDeferID();return this.sendMessage(r.GET_FLOAT_ARRAY,{variable:e,callback:t}),this.deferredPromises[t].value()}setFloatArrayValue(e,t,a){this.sendMessage(r.SET_FLOAT_ARRAY_VALUE,{variable:e,index:t,value:a})}getFloatArrayValue(e,t){const a=this.nextDeferID();return this.sendMessage(r.GET_FLOAT_ARRAY_VALUE,{variable:e,index:t,callback:a}),this.deferredPromises[a].value()}setAssociativeFloatArrayValue(e,t,a){this.sendMessage(r.SET_ASSOCIATIVE_FLOAT_ARRAY_VALUE,{variable:e,key:t,value:a})}getAssociativeFloatArrayValue(e,t){const a=this.nextDeferID();return this.sendMessage(r.GET_ASSOCIATIVE_FLOAT_ARRAY_VALUE,{variable:e,key:t,callback:a}),this.deferredPromises[a].value()}setParamInt(e,t){this.sendMessage(r.SET_PARAM_INT,{name:e,value:t})}getParamInt(e){const t=this.nextDeferID();return this.sendMessage(r.GET_PARAM_INT,{name:e,callback:t}),this.deferredPromises[t].value()}setParamFloat(e,t){this.sendMessage(r.SET_PARAM_FLOAT,{name:e,value:t})}getParamFloat(e){const t=this.nextDeferID();return this.sendMessage(r.GET_PARAM_FLOAT,{name:e,callback:t}),this.deferredPromises[t].value()}setParamString(e,t){this.sendMessage(r.SET_PARAM_STRING,{name:e,value:t})}getParamString(e){const t=this.nextDeferID();return this.sendMessage(r.GET_PARAM_STRING,{name:e,callback:t}),this.deferredPromises[t].value()}now(){const e=this.nextDeferID();return this.sendMessage(r.GET_CHUCK_NOW,{callback:e}),this.deferredPromises[e].value()}clearChuckInstance(){this.sendMessage(r.CLEAR_INSTANCE)}clearGlobals(){this.sendMessage(r.CLEAR_GLOBALS)}chuckPrint(e){console.log(e)}sendMessage(e,t){const a=t?{type:e,...t}:{type:e};this.port.postMessage(a)}receiveMessage(e){switch(e.data.type){case c.INIT_DONE:this.isReady&&this.isReady.resolve&&this.isReady.resolve();break;case c.PRINT:this.chuckPrint(e.data.message);break;case c.EVENT:if(e.data.callback in this.eventCallbacks){const a=this.eventCallbacks[e.data.callback];a()}break;case c.INT:case c.FLOAT:case c.STRING:case c.INT_ARRAY:case c.FLOAT_ARRAY:if(e.data.callback in this.deferredPromises){const a=this.deferredPromises[e.data.callback];a.resolve&&a.resolve(e.data.result),delete this.deferredPromises[e.data.callback]}break;case c.NEW_SHRED:if(e.data.callback in this.deferredPromises){const a=this.deferredPromises[e.data.callback];e.data.shred>0?a.resolve&&a.resolve(e.data.shred):a.reject&&a.reject("Running code failed")}break;case c.REPLACED_SHRED:if(e.data.callback in this.deferredPromises){const a=this.deferredPromises[e.data.callback];e.data.newShred>0?a.resolve&&a.resolve({newShred:e.data.newShred,oldShred:e.data.oldShred}):a.reject&&a.reject("Replacing code failed")}break;case c.REMOVED_SHRED:if(e.data.callback in this.deferredPromises){const a=this.deferredPromises[e.data.callback];e.data.shred>0?a.resolve&&a.resolve(e.data.shred):a.reject&&a.reject("Removing code failed")}break}}}d.chuckID=1;d.chuginsToLoad=[];var b;(function(s){s[s.BUTTON_DOWN=1]="BUTTON_DOWN",s[s.BUTTON_UP=2]="BUTTON_UP",s[s.MOUSE_MOTION=5]="MOUSE_MOTION",s[s.WHEEL_MOTION=6]="WHEEL_MOTION"})(b||(b={}));const i=new G;await i.init({background:"#dadada",resizeTo:window});document.getElementById("pixi-container").appendChild(i.canvas);i.ticker.maxFPS=30;const C=await k.load("/assets/0.jpg"),h=await k.load("/assets/tilesetwhite.png");h.source.scaleMode="nearest";let I=[],S=[],R=[],p=[],j=[],L=[];for(let s=0;s<4;s++)for(let e=0;e<4;e++){const t=_(i,h,A[s*4+e][0][0],s*4+e),a=_(i,h,A[s*4+e][1][0],s*4+e);S.push(t.bg),R.push([t.composite,a.composite]),p.push(t.solid);const n=Math.min(i.canvas.width,i.canvas.height)/6,l=n*1.3,E=n*1.4,T=V((i.canvas.width-3.5*l)/2+e*l,(i.canvas.height-3.5*E)/2+s*E,n/105,C,t.bg);I.push(T),L.push(T.y),i.stage.addChild(T)}let o;(async()=>{let s=[{serverFilename:"/chuck/tapper.ck",virtualFilename:"tapper.ck"}].concat(Array.from({length:32},(e,t)=>({serverFilename:`/chuck/tracks/TRACK ${Math.floor(t/2)+1}-${t%2+1}.wav`,virtualFilename:`tracks/TRACK ${Math.floor(t/2)+1}-${t%2+1}.wav`})).filter((e,t)=>e.virtualFilename.indexOf("14-")==-1&&e.virtualFilename.indexOf("16-")==-1));o=await d.init(s),await o.runFile("tapper.ck"),o.startListeningForEvent("soundEvent",()=>{o.getIntArray("poss").then(e=>{for(let t=0;t<e.length-1;t++)e[t]==1&&y(j,I[t],t,{baseTextures:S,specTextures:R,baseTexture:C,topTextures:p})}),document.getElementById("start-button").addEventListener("click",async()=>{o.context.state==="suspended"&&o.context.resume()})}),B()})();function B(){const s=new f.WebsocketClientPlugin({host:v,port:P,secure:g}),e=new f({discardLateMessages:!0,plugin:s});return e.on("open",()=>{e.send(new f.Message("/viewing",1))}),e.on("/players",t=>{let a=JSON.parse(t.args[0]);a.forEach(n=>{n.pos=Number(n.pos),n.setting=Number(n.setting)}),K(a)}),e.on("/enabled",t=>{let a=JSON.parse(t.args[0]);console.log(a),$(a)}),e.on("/player/tap",t=>{let a=t.args[0];x(I[a],L[a])}),e.on("/setting",t=>{let a=t.args[0],n=t.args[1];if(a==15){const l=_(i,h,A[15][0][n],15),E=_(i,h,A[15][1][n],15);O(I[15],[l.composite,E.composite,l.solid]);return}J({pos:a,setting:n})}),e.on("/volume",t=>{let a=t.args[0],n=t.args[1];if(a==13){X(Math.abs(n)/10);return}z(a,n)}),e.on("/pan",t=>{let a=t.args[0],n=t.args[1];q(a,n)}),e.open(),e}function $(s){const e=new Array(16).fill(0);for(let t=0;t<s.length;t++)e[t]=s[t];o.setIntArray("enabled_sounds",e)}function K(s){const e=new Array(16).fill(0);s.forEach(t=>{isNaN(t.pos)||(e[t.pos]=t.setting)}),o.setIntArray("setting_sounds",e)}function J(s){Q(s.pos,s.setting),o.setIntArrayValue("setting_sounds",s.pos,[s.setting])}function z(s,e){o.setFloatArrayValue("gains_sounds",s,e)}function q(s,e){o.setFloatArrayValue("pans_sounds",s,e)}function X(s){o.setFloat("rev14",s)}function Q(s,e){const t=_(i,h,A[s][0][e],s),a=_(i,h,A[s][1][e],s);R[s][0]=t.composite,R[s][1]=a.composite}
